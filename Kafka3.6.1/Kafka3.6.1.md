# 架构

![](img/01.png)

横向扩展：增加服务节点，搭建服务器集群，降低单点故障所带来的风险。

纵向扩展：增加系统的资源配置，比如，使用IO效率更好的固态硬盘、更大的内存、更多的CPU核、更快的网络。



**当前的IO热点问题，需要横向的对Broker节点进行扩展**

![](img/02.png)

- 为了数据可靠性，可以将数据文件进行备份，但是Kafka没有备份的概念
  - Kafka中称之为副本，多个副本同时只能有一个提供数据的读写操作，其他副本只是用于备份
    - 具有读写能力的副本称之为Leader副本，作为备份的副本称之为Follower副本

Broker：服务节点（集群）

Partition：分区（编号，从0开始）把一个Topic切分成多块

副本：Leader和Follower



**给管理者增加备份**

![](img/03.png)



**核心组件**

Kafka 作为独立的分布式消息传输系统，还需要第三方软件ZooKeeper进行节点之间的协调调度，不能实现自我的管理，导致Kafka和其他软件之间形成耦合，制约了Kafka的发展，甚至会成为Kafka性能的瓶颈。从Kafka2.8开始增加特定的算法来实现节点之间的协调管理，在Kafka4版本中完全移除ZooKeeper

![](img/04.png)





# 启动服务

## ZooKeeper的核心功能

Kafka 利用这些功能进行集群管理

![](img/05.png)



## Broker启动后ZooKeeper节点的变化

![](img/06.png)

​                Broker的一个组件                                                                     ZooKeeper服务器中的节点



## Controller的选举

![](img/07.png)



## Controller和Broker的通信原理和底层通信机制

![](img/08.png)

![](img/09.png)

![](img/10.png)

![](img/11.png)



![](img/12.png)



## Broker组件对象（源码）

`KafkaServer.scala`





# 创建主题

## 主题分区副本分配策略

一个主题

![](img/13.png)

三个主题

![](img/14.png)



## 底层流程

![](img/15.png)



![](img/16.png)





# 生产数据

## 生产者流程分析

![](img/17.png)



## 拦截器和序列化处理

![](img/18.png)



## 分区器及分区计算策略

分区编号计算：粘性分区策略



## 数据收集器和Sender发送线程

![](img/19.png)



## 数据的异步发送和同步发送





## ACKS数据接收应答处理机制

![](img/20.png)

![](img/21.png)

![](img/22.png)



## 数据重复及乱序的原因及原理

重试

![](img/23.png)

重复

![](img/24.png)

乱序

![](img/25.png)



## 幂等性操作

> Kafka为了解决数据的重复和乱序问题，提供了幂等性操作。

幂等性操作的要求

1. ACKS = -1（默认是-1）
2. 开启重试机制
3. 在途请求缓冲区的数量不能大于5（默认是5）

![](img/26.png)



## 事务操作

> 生产者ID发生变化（生产者跨会话）导致幂等性失效，通过事务解决

![](img/27.png)





# 存储数据

## 数据存储流程

![](img/28.png)



## 数据文件内容及数据定位

index文件称之为稀疏索引

![](img/29.png)



## 数据文件字节计算方式





## 数据同步一致性问题

![](img/30.png)

**副本同步时的水位线变化**

![](img/31.png)

![](img/32.png)

**ISR列表变化和传播**

![](img/33.png)





# 消费数据

![](img/34.png)



## 分区分配策略

![](img/35.png)



## 流程

![](img/36.png)





# 扩展

## 分布式集群脑裂问题

![](img/37.png)



## 零拷贝

![](img/38.png)

![](img/39.png)







